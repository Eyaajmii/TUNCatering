<div class="container">
  <div *ngIf="loading" class="text-center mt-3">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger text-center">
    {{ error }}
  </div>
  
  <div class="filters mb-3">
    <select id="filtreStatut" [(ngModel)]="selectedStatut">
      <option value="Tous">Tous</option>
      <option value="en attente">En attente</option>
      <option value="traitée">Traitée</option>
    </select>
    <input type="text" [(ngModel)]="matriculeFilter" placeholder="Filtrer par matricule" class="form-control"/>
  </div>
  
  <div *ngIf="!loading && !error" class="card mt-3">
    <div *ngIf="message" class="message-box">
      {{ message }}
    </div> 
    <div class="card-header">
      <h3>LISTE DES RÉCLAMATIONS</h3>
    </div>
    <div class="card-body">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>N° Réclamation</th>
            <th>Matricule Personnel</th>
            <th>Commande</th>
            <th>Objet</th>
            <th>Message</th>
            <th>Réponse</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <ng-container  *ngFor="let r of ReclamationFiltres">
            <tr (click)="toggleDetails(r._id)" style="cursor: pointer;">
            <td>{{ r.NumeroReclamation }}</td>
            <td>{{ r.MatriculePn }}</td>
            <td>{{ r.Commande }}</td>
            <td>{{ r.Objet }}</td>
            <td>{{ r.MessageEnvoye }}</td>
            <td>
              <!-- Si réponse déjà envoyée, on l'affiche -->
              <div *ngIf="r.Statut === 'traitée'; else formReponse">
                <p>{{ r.MessageReponse }}</p>
              </div>
              <ng-template #formReponse>
                <textarea 
                  [(ngModel)]="r.MessageReponse" 
                  rows="2" 
                  placeholder="Répondre...">
                </textarea>
              </ng-template>
            </td>
            <td>
              <button 
                class="btn btn-sm btn-primary"
                (click)="changer(r._id, r.MessageReponse)">
                {{ r.Statut === 'traitée' ? 'Répondu' : 'Valider' }}
              </button>
            </td>
          </tr>
          <tr *ngIf="selectedRecId === r._id && selectedRecDetail">
            <td colspan="7">
              <div class="detail-card p-3 bg-light rounded shadow-sm">
                <h5 class="mb-3">Détails de réclamation</h5>
                <ul class="list-group list-group-flush">
                  <li class="list-group-item">
                    <strong>Message envoyé :</strong> {{ selectedRecDetail.MessageEnvoye }}
                  </li>
                  <li class="list-group-item" *ngIf="selectedRecDetail.MessageReponse">
                    <strong>Réponse :</strong> {{ selectedRecDetail.MessageReponse }}
                  </li>
                  <li class="list-group-item">
                    <strong>Date de création :</strong> {{ selectedRecDetail.createdAt | date: 'short' }}
                  </li>
                  <li class="list-group-item" *ngIf="selectedRecDetail.imageUrl">
                    <strong>Image jointe :</strong><br>
                    <img class="plat-image" [src]="'http://localhost:5000/uploads/' + selectedRecDetail.imageUrl" alt="{{selectedRecDetail.imageUrl}}">
                  </li>
                </ul>
              </div>
            </td>
          </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>
</div>