<div class="container">
  <div *ngIf="isLoading" class="text-center mt-3">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger mt-3">
    {{ errorMessage }}
  </div>

  <div *ngIf="successMessage" class="alert alert-success mt-3">
    {{ successMessage }}
  </div>
  <div class=" filters mb-3">
    <select id="filtreStatut"  [(ngModel)]="selectedStatut">
      <option value="Tous">Tous</option>
      <option value="En attente">En attente</option>
      <option value="Annulé">Annulé</option>
      <option value="Validé">Validé</option>
    </select>
  </div>
  <div class="card mt-3">
    <div class="card-header"><h3>LISTE DES BONS DE LIVRAISON</h3></div>
    <div class="card-body">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>N° bon Livraison</th>
            <th>Vol</th>
            <th>Nombre des Commandes</th>
            <th>Personnel Livraison</th>
            <th>Statut</th>
            <th>Conformité</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let bon of bonsLivraisonFiltres" >
          <tr [class.table-secondary]="bon.Statut === 'Annulé'" (click)="toggleDetails(bon._id)"  style="cursor: pointer;">
            <td class="fw-semibold text-primary">{{ bon.numeroBon }}</td>
            <td>{{bon.vol.numVol}}</td>
            <td>{{ bon.commandes.length || 0 }}</td>
            <td>
              {{ bon.personnelLivraison|| 'Non assigné' }}
            </td>
            <td>
              <span class="badge" [ngClass]="getStatusBadgeClass(bon.Statut)">
                {{ bon.Statut }}
              </span>
            </td>
            <td>
              <span class="badge" [ngClass]="getConformiteBadgeClass(bon.conformite)">
                {{ bon.conformite }}
              </span>
            </td>
            <td>
              <button 
                (click)="downloadPdf(bon.numeroBon)" 
                class="btn btn-sm btn-primary me-2"
                [disabled]="isLoading">
                <i class="bi bi-download"></i> PDF
              </button>
              <button  (click)="aller(bon._id)" 
                class="btn btn-sm btn-secondary" [disabled]="bon.Statut == 'Annulé' || bon.Statut =='Validé' ">
                <i class="fas fa-check-circle text-success"></i> Contrôler
              </button>
            </td>
          </tr>
          <tr *ngIf="selectedBnId === bon._id && selectedBnDetail">
            <td colspan="6">
              <div class="detail-card">
                <h5>Détails du bon de livraison {{ selectedBnDetail?.numeroBon }}</h5>
                <p><strong>Date :</strong> {{ selectedBnDetail?.dateCreation | date:'short' }}</p>
                <p><strong>Statut :</strong> {{ selectedBnDetail?.Statut }}</p>
                <p><strong>Vol :</strong> {{ selectedBnDetail?.vol.numVol }}</p>
                <p><strong>Facturé :</strong> {{ selectedBnDetail?.['Facturé'] ? 'Oui' : 'Non' }}</p>
          
                <h6>Commandes associées :</h6>
                <ul>
                  <li *ngFor="let c of selectedBnDetail?.commandes">
                    <strong>#{{ c.commande?.numeroBon }}</strong> - 
                    {{ c.commande?.dateCreation | date:'shortDate' }} - 
                    Statut : {{ c.commande?.Statut }}
                    <span *ngIf="c.confirme"> (Confirmé)</span>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
    <div *ngIf="!isLoading && bonsLivraison.length === 0 && !errorMessage" class="alert alert-info mt-3">
      Aucun bon de livraison trouvé.
    </div>
  </div>
</div>